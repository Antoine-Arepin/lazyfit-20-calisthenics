import React, { useState, useEffect, useCallback, useMemo } from 'react';
import {
  Home, Dumbbell, Settings, Calendar, Play, Pause, FastForward, Check, Clock, Flame, BarChart3, ChevronDown, ChevronUp, RefreshCw, Volume2, VolumeX, Zap, User, PlusCircle, Trash2, Edit, Award, Download, Goal, UserCog
} from 'lucide-react';

// --- 1. Constants & Database ---

const VERSION = 'v2.0';
const REST_DURATION = 10;
const REWARDED_AD_SECONDS = 5; // Placeholder for ad length

const DIFFICULTY_MULTIPLIERS = {
  Beginner: 0.7, // Shorter duration
  Intermediate: 1.0, // Standard duration
  Advanced: 1.3, // Longer duration
};

const DIFFICULTY_COLORS = {
  Beginner: 'text-green-400',
  Intermediate: 'text-yellow-400',
  Advanced: 'text-red-400',
};

const EXERCISES_DB = [
  {
    id: 1, name: 'Jumping Jacks', baseDuration: 45, caloriesPerMin: 10,
    variations: [
      { name: 'Step Jacks', level: 'Beginner', description: 'Step one leg out at a time instead of jumping.' },
      { name: 'Jumping Jacks (Base)', level: 'Intermediate', description: 'Perform the classic exercise with good form.' },
      { name: 'Star Jumps', level: 'Advanced', description: 'Explosive full-body jump with arms and legs wide.' }
    ]
  },
  {
    id: 2, name: 'Push-ups', baseDuration: 30, caloriesPerMin: 12,
    variations: [
      { name: 'Wall Push-ups', level: 'Beginner', description: 'Push against a wall to reduce resistance.' },
      { name: 'Standard Push-ups (Base)', level: 'Intermediate', description: 'Classic push-up focusing on chest and triceps.' },
      { name: 'Decline Push-ups', level: 'Advanced', description: 'Elevate your feet to increase resistance.' }
    ]
  },
  {
    id: 3, name: 'Squats', baseDuration: 45, caloriesPerMin: 9,
    variations: [
      { name: 'Chair Squats', level: 'Beginner', description: 'Squat until your glutes tap a chair, then stand up.' },
      { name: 'Bodyweight Squats (Base)', level: 'Intermediate', description: 'Standard air squat, keeping chest up.' },
      { name: 'Jump Squats', level: 'Advanced', description: 'Add a vertical jump at the top for explosive power.' }
    ]
  },
  {
    id: 4, name: 'Plank', baseDuration: 30, caloriesPerMin: 6,
    variations: [
      { name: 'Knee Plank', level: 'Beginner', description: 'Hold the plank position with your knees on the floor.' },
      { name: 'High Plank (Base)', level: 'Intermediate', description: 'Forearm or hand plank, maintain a straight line.' },
      { name: 'Plank with Shoulder Taps', level: 'Advanced', description: 'Tap opposite shoulders while maintaining form.' }
    ]
  },
  {
    id: 5, name: 'Lunges', baseDuration: 40, caloriesPerMin: 11,
    variations: [
      { name: 'Backward Lunges', level: 'Beginner', description: 'Step backward instead of forward for better stability.' },
      { name: 'Forward Lunges (Base)', level: 'Intermediate', description: 'Standard lunge, knee to 90 degrees.' },
      { name: 'Jumping Lunges', level: 'Advanced', description: 'Jump and switch legs mid-air for cardio.' }
    ]
  },
  {
    id: 6, name: 'High Knees', baseDuration: 30, caloriesPerMin: 14,
    variations: [
      { name: 'March in Place', level: 'Beginner', description: 'March slowly, lifting knees to waist height.' },
      { name: 'High Knees (Base)', level: 'Intermediate', description: 'Run in place, driving knees up quickly.' },
      { name: 'High Knee Sprints', level: 'Advanced', description: 'Maximum speed and intensity.' }
    ]
  },
  {
    id: 7, name: 'Mountain Climbers', baseDuration: 30, caloriesPerMin: 13,
    variations: [
      { name: 'Slow Climbers', level: 'Beginner', description: 'Perform the movement slowly, focusing on core engagement.' },
      { name: 'Mountain Climbers (Base)', level: 'Intermediate', description: 'Run knees toward chest in a plank position.' },
      { name: 'Cross-Body Climbers', level: 'Advanced', description: 'Bring knees toward the opposite elbow.' }
    ]
  },
];

const ACHIEVEMENTS = [
  { id: 1, name: 'First Sweat', condition: (history) => history.length >= 1, description: 'Complete your first workout.', icon: Fire },
  { id: 2, name: '3-Day Streaker', condition: (_, streak) => streak >= 3, description: 'Maintain a 3-day workout streak.', icon: Flame },
  { id: 3, name: 'The Dedication', condition: (history) => history.length >= 10, description: 'Complete 10 total workouts.', icon: Award },
  { id: 4, name: 'Master Advanced', condition: (history) => history.some(w => w.difficulty === 'Advanced'), description: 'Complete a workout on Advanced difficulty.', icon: Zap },
];


// --- 2. Utility Functions ---

const loadState = (key, defaultValue) => {
  try {
    const serializedState = localStorage.getItem(key);
    if (serializedState === null) return defaultValue;
    return JSON.parse(serializedState);
  } catch (error) {
    console.error("Error loading state from localStorage:", error);
    return defaultValue;
  }
};

const saveState = (key, state) => {
  try {
    localStorage.setItem(key, JSON.stringify(state));
  } catch (error) {
    console.error("Error saving state to localStorage:", error);
  }
};

const formatTime = (seconds) => {
  const min = Math.floor(seconds / 60);
  const sec = seconds % 60;
  return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
};

const getDuration = (baseDuration, difficulty) => {
  const multiplier = DIFFICULTY_MULTIPLIERS[difficulty] || 1.0;
  return Math.round(baseDuration * multiplier);
};

const generateWorkout = (count, difficulty, customExercises = null) => {
  const exercises = customExercises || EXERCISES_DB.sort(() => 0.5 - Math.random()).slice(0, count);

  return exercises.map(ex => {
    const duration = getDuration(ex.baseDuration, difficulty);
    const baseVariation = ex.variations.find(v => v.level === 'Intermediate');

    return {
      ...ex,
      baseName: baseVariation?.name || ex.name,
      baseDescription: baseVariation?.description || 'Perform the classic exercise.',
      baseDuration: duration,
      caloriesPerMin: ex.caloriesPerMin,
      isLazy: false,
      duration: duration,
      status: 'pending',
    };
  });
};

const calculateTotalTime = (workout) => {
    if (!workout || workout.length === 0) return 0;
    const exerciseTime = workout.reduce((sum, ex) => sum + (ex.duration || ex.baseDuration), 0);
    const restTime = (workout.length - 1) * REST_DURATION;
    return exerciseTime + Math.max(0, restTime);
}

// --- 3. Custom Components ---

const Header = ({ onNavigate, screen }) => {
  const NavButton = ({ icon: Icon, targetScreen, currentScreen, label }) => (
    <button
      onClick={() => onNavigate(targetScreen)}
      className={`p-3 rounded-xl transition-colors ${currentScreen === targetScreen ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-400 hover:bg-gray-700'}`}
      aria-label={label}
    >
      <Icon size={20} />
    </button>
  );

  return (
    <header className="flex justify-between items-center p-4 bg-gray-900 shadow-2xl sticky top-0 z-20 border-b border-gray-700">
      <h1 className="text-xl font-bold text-white tracking-wider flex items-center">
        LazyFit 20 <span className="text-sm ml-2 text-indigo-400 font-medium">{VERSION}</span>
      </h1>
      <div className="flex space-x-2">
        <NavButton icon={Home} targetScreen="Home" currentScreen={screen} label="Home" />
        <NavButton icon={Dumbbell} targetScreen="Builder" currentScreen={screen} label="Workout Builder" />
        <NavButton icon={BarChart3} targetScreen="Progress" currentScreen={screen} label="Progress" />
        <NavButton icon={UserCog} targetScreen="Profile" currentScreen={screen} label="Profile & Settings" />
      </div>
    </header>
  );
};

const StatCard = ({ icon: Icon, label, value, color }) => (
  <div className="flex flex-col items-center bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 hover:bg-gray-700 transition-colors">
    <Icon size={24} className={`mb-2 ${color}`} />
    <span className="text-white font-bold text-xl">{value}</span>
    <span className="text-gray-400 text-xs uppercase tracking-wider">{label}</span>
  </div>
);

const CompletionModal = ({ workoutData, onClose, onBackToHome }) => {
  const totalCalories = Math.round(workoutData.calories);
  const totalTime = formatTime(workoutData.duration);
  const totalExercises = workoutData.exercises.length;

  return (
    <div className="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50 p-4">
      <div className="bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center border-4 border-green-500 animate-in zoom-in duration-300">
        <Check size={64} className="text-green-500 mx-auto mb-4 animate-pulse" />
        <h2 className="text-4xl font-extrabold text-white mb-2">Workout Complete!</h2>
        <p className="text-indigo-400 mb-6 text-lg">
          You earned that streak! Difficulty: <span className={DIFFICULTY_COLORS[workoutData.difficulty]}>{workoutData.difficulty}</span>
        </p>

        <div className="grid grid-cols-3 gap-2 mb-8">
          <StatCard icon={Clock} label="Time" value={totalTime} color="text-indigo-400" />
          <StatCard icon={Dumbbell} label="Exercises" value={totalExercises} color="text-yellow-400" />
          <StatCard icon={Flame} label="Calories" value={`${totalCalories} kcal`} color="text-red-400" />
        </div>

        <button
          onClick={onBackToHome}
          className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-xl transition-colors shadow-lg mt-4"
        >
          Back to Home
        </button>
      </div>
    </div>
  );
};

const LoadingSpinner = () => (
    <div className="flex items-center justify-center py-8">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
        <span className="text-gray-400 ml-3">Generating workout...</span>
    </div>
);

// --- 4. Screen Components ---

const HomeScreen = ({ streak, onStartWorkout, preferences, customWorkouts, onSelectCustomWorkout }) => {
  const [selectedWorkout, setSelectedWorkout] = useState(null);

  const workoutOptions = useMemo(() => ([
    { id: 'random', name: 'Random Daily 20', type: 'System', duration: '~20m' },
    ...customWorkouts.map(cw => ({
      id: cw.id,
      name: cw.name,
      type: 'Custom',
      duration: formatTime(calculateTotalTime(cw.exercises)),
    }))
  ]), [customWorkouts]);

  const handleStart = () => {
    if (selectedWorkout && selectedWorkout.type === 'Custom') {
      const customW = customWorkouts.find(cw => cw.id === selectedWorkout.id);
      if (customW) {
        onSelectCustomWorkout(customW);
        return;
      }
    }
    // Default or Random Daily 20
    onStartWorkout();
  };

  const currentSelection = selectedWorkout || workoutOptions[0];

  return (
    <div className="p-6 flex flex-col items-center justify-center h-full text-center">
      <div className="flex items-center justify-center bg-gray-800 p-4 rounded-full mb-8 shadow-xl shadow-red-900/50">
        <Flame size={28} className="text-red-400 mr-3 animate-pulse" />
        <span className="text-3xl font-black text-white">{`ðŸ”¥ ${streak} Day Streak`}</span>
      </div>

      <h2 className="text-5xl font-extrabold text-white mb-4 leading-tight">
        Ready for your 20 minutes?
      </h2>
      <p className="text-xl text-gray-400 mb-8">
        Difficulty: <span className={DIFFICULTY_COLORS[preferences.difficulty]}>{preferences.difficulty}</span>
      </p>

      {/* Workout Selector */}
      <div className="w-full max-w-sm mb-12">
        <label htmlFor="workout-select" className="block text-left text-gray-300 mb-2 font-semibold">Select Workout:</label>
        <select
          id="workout-select"
          className="w-full bg-gray-700 text-white p-3 rounded-xl border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500"
          value={currentSelection.id}
          onChange={(e) => setSelectedWorkout(workoutOptions.find(opt => opt.id === e.target.value))}
        >
          {workoutOptions.map(opt => (
            <option key={opt.id} value={opt.id}>
              {opt.name} ({opt.type}, {opt.duration})
            </option>
          ))}
        </select>
      </div>

      <button
        onClick={handleStart}
        className="w-full max-w-xs bg-indigo-600 hover:bg-indigo-500 text-white font-black text-2xl py-5 px-10 rounded-3xl transition-all duration-300 shadow-2xl shadow-indigo-700/50 transform hover:scale-105"
      >
        START WORKOUT
      </button>

      <div className="absolute bottom-4 w-full px-6">
        <div className="bg-yellow-800 text-yellow-200 text-xs text-center py-2 rounded-lg italic">
          [ AD PLACEHOLDER: Get 1 Month Free! ]
        </div>
      </div>
    </div>
  );
};

const WorkoutScreen = ({
  currentWorkout,
  currentExerciseIndex,
  workoutState,
  timeRemaining,
  preferences,
  setWorkoutState,
  setTimeRemaining,
  setCurrentExerciseIndex,
  onCompleteWorkout,
}) => {
  const [isLazyMode, setIsLazyMode] = useState(preferences.lazyModeDefault);
  const [adTimeRemaining, setAdTimeRemaining] = useState(0);
  const [showInstructions, setShowInstructions] = useState(false);

  const currentEx = currentWorkout[currentExerciseIndex];
  const totalExercises = currentWorkout.length;
  const isRest = workoutState === 'rest';
  const exerciseStatusText = isRest ? 'REST' : 'WORK';

  // Determine the current duration goal
  const durationGoal = isRest ? REST_DURATION : currentEx.duration;

  // Find the appropriate variation for the current mode
  const currentVariation = useMemo(() => {
    // If not lazy, use the base variation name stored when workout was generated
    if (!isLazyMode) {
      return { name: currentEx.baseName, description: currentEx.baseDescription, level: preferences.difficulty };
    }
    // If lazy, find the 'Beginner' variation from the master database
    const dbEntry = EXERCISES_DB.find(e => e.id === currentEx.id);
    const lazyVariation = dbEntry?.variations.find(v => v.level === 'Beginner');
    return lazyVariation || { name: 'Lazy Mode', description: 'Simplified version.', level: 'Beginner' };

  }, [currentEx, isLazyMode, preferences.difficulty]);


  // Auto-Progression Logic (Timer useEffect)
  useEffect(() => {
    if (workoutState === 'in-progress' || workoutState === 'rest' || adTimeRemaining > 0) {
      const interval = setInterval(() => {
        if (adTimeRemaining > 0) {
          setAdTimeRemaining(t => t - 1);
        } else if (timeRemaining > 1) {
          setTimeRemaining(t => t - 1);
        } else {
          // Time is up (timeRemaining === 1)
          if (isRest) {
            // End rest, start next exercise
            setWorkoutState('in-progress');
            setCurrentExerciseIndex(i => i + 1);
          } else {
            // End exercise, start rest or complete
            if (currentExerciseIndex < totalExercises - 1) {
              setWorkoutState('rest');
              setTimeRemaining(REST_DURATION);
            } else {
              // Workout finished!
              onCompleteWorkout();
            }
          }
        }
      }, 1000);

      return () => clearInterval(interval);
    }
  }, [workoutState, timeRemaining, currentExerciseIndex, totalExercises, isRest, setTimeRemaining, setWorkoutState, setCurrentExerciseIndex, onCompleteWorkout, adTimeRemaining]);

  // Sync Timer when exercise changes or lazy mode toggles
  useEffect(() => {
    if (currentEx) {
      if (workoutState === 'in-progress') {
        setTimeRemaining(currentEx.duration);
      } else if (workoutState === 'rest') {
        setTimeRemaining(REST_DURATION);
      }
    }
    // Reset lazy mode for new exercise unless default is set
    if (currentExerciseIndex > 0) {
      setIsLazyMode(preferences.lazyModeDefault);
    }
  }, [currentExerciseIndex, preferences.lazyModeDefault]);


  const handlePauseToggle = () => {
    setWorkoutState(workoutState === 'in-progress' || workoutState === 'rest' ? 'paused' : 'in-progress');
  };

  const handleSkip = () => {
    if (adTimeRemaining > 0) return;

    // Placeholder: Start Rewarded Ad sequence
    setWorkoutState('ad-break');
    setAdTimeRemaining(REWARDED_AD_SECONDS);

    // After ad (simulated by timeout), advance
    setTimeout(() => {
      setAdTimeRemaining(0);
      setWorkoutState('in-progress'); // Ensure state is restored
      handleMarkDone();
    }, REWARDED_AD_SECONDS * 1000);
  };

  const handleMarkDone = () => {
    // Save the actual duration performed (if manual skip)
    currentWorkout[currentExerciseIndex].actualDuration = currentEx.duration - timeRemaining;

    if (currentExerciseIndex < totalExercises - 1) {
      // Mark current as done and start rest
      setWorkoutState('rest');
      setTimeRemaining(REST_DURATION);
    } else {
      // Workout finished!
      onCompleteWorkout();
    }
  };

  const badgeColor = DIFFICULTY_COLORS[currentVariation.level].replace('text-', 'bg-');

  if (!currentEx) return <LoadingSpinner />;

  return (
    <div className="p-4 flex flex-col h-full overflow-hidden">
      {/* Top Section: Video Placeholder & Controls */}
      <div className="relative w-full aspect-video bg-gray-900 rounded-xl shadow-2xl mb-4 overflow-hidden">
        <div className="flex items-center justify-center h-full text-center text-gray-500">
          <Dumbbell size={60} className="text-indigo-600/50" />
          <p className="absolute bottom-4 bg-gray-900/70 text-sm p-1 rounded">
            Video Guide Placeholder: {currentEx.name}
          </p>
        </div>
        <button
          onClick={handlePauseToggle}
          className="absolute top-3 right-3 p-3 bg-gray-900/80 hover:bg-gray-800 rounded-full text-white shadow-lg transition-all"
        >
          {workoutState === 'in-progress' || workoutState === 'rest' ? <Pause size={20} /> : <Play size={20} />}
        </button>
      </div>

      {/* Progress Indicator */}
      <div className="text-center mb-4">
        <p className="text-gray-400 font-semibold uppercase">
          Exercise {currentExerciseIndex + 1} of {totalExercises}
        </p>
        <div className="h-2 w-full bg-gray-700 rounded-full overflow-hidden mt-1">
          <div
            className="h-full bg-indigo-500 transition-all duration-300"
            style={{ width: `${((currentExerciseIndex + 1) / totalExercises) * 100}%` }}
          ></div>
        </div>
      </div>

      {/* Exercise Info & Timer */}
      <div className="flex-1 overflow-y-auto pb-4">
        <div className="bg-gray-700 p-4 rounded-xl shadow-inner mb-4">
          <div className="flex justify-between items-center">
            <h2 className="text-3xl font-extrabold text-white mb-2">{currentVariation.name}</h2>
            <span className={`px-3 py-1 text-xs font-semibold rounded-full text-white ${badgeColor}`}>
              {currentVariation.level}
            </span>
          </div>
          <p className="text-gray-400 mb-4 italic">{currentVariation.description}</p>

          {/* Lazy Mode Toggle */}
          <button
            onClick={() => setIsLazyMode(prev => !prev)}
            className={`w-full py-2 mb-4 rounded-lg font-semibold transition-colors flex items-center justify-center ${
              isLazyMode ? 'bg-indigo-500 hover:bg-indigo-400' : 'bg-green-600 hover:bg-green-500'
            } text-white`}
          >
            {isLazyMode ? <RefreshCw size={16} className="mr-2" /> : <Zap size={16} className="mr-2" />}
            {isLazyMode ? 'Back to Base Mode' : 'Go Lazy (Beginner Variation)'}
          </button>

          {/* Instructions Modal/Expandable */}
          <button
            onClick={() => setShowInstructions(!showInstructions)}
            className="w-full text-indigo-400 hover:text-indigo-300 flex justify-center items-center py-1"
          >
            {showInstructions ? 'Hide Instructions' : 'Show Instructions'}
            {showInstructions ? <ChevronUp size={16} className="ml-1" /> : <ChevronDown size={16} className="ml-1" />}
          </button>
          {showInstructions && (
            <div className="mt-3 p-3 bg-gray-600 rounded-lg text-sm text-gray-200 animate-in slide-in-from-top-4 duration-300">
              <ul className="list-disc list-inside space-y-1">
                <li>Duration goal is {formatTime(durationGoal)}.</li>
                <li>Maintain a steady, controlled pace.</li>
                <li>Focus on core stability.</li>
              </ul>
            </div>
          )}
        </div>

        {/* Timer Display */}
        <div className={`text-center p-6 rounded-xl shadow-2xl transition-all duration-500 transform ${isRest ? 'bg-red-700/80 border-red-500' : 'bg-indigo-700/80 border-indigo-500'} border-4`}>
          <p className="text-xl font-bold text-white mb-1 uppercase tracking-widest">
            {adTimeRemaining > 0 ? 'AD BREAK' : exerciseStatusText}
          </p>
          <div className="text-8xl font-black text-white">{formatTime(timeRemaining)}</div>
          <p className="text-sm text-gray-200 mt-1">{isRest ? 'Next: ' + currentWorkout[currentExerciseIndex + 1]?.name : 'Total Duration: ' + formatTime(durationGoal)}</p>
        </div>

        {/* Progress Bar for Timer */}
        <div className="h-4 w-full bg-gray-700 rounded-full overflow-hidden mt-4">
          <div
            className={`h-full ${isRest ? 'bg-red-400' : 'bg-green-400'} transition-all duration-1000`}
            style={{ width: `${(durationGoal - timeRemaining) / durationGoal * 100}%` }}
          ></div>
        </div>
      </div>

      {/* Control Buttons */}
      <div className="flex space-x-3 pt-4 border-t border-gray-700">
        <button
          onClick={handleSkip}
          disabled={adTimeRemaining > 0}
          className={`flex-1 flex items-center justify-center py-3 rounded-xl font-semibold transition-colors ${adTimeRemaining > 0 ? 'bg-gray-500 cursor-not-allowed' : 'bg-yellow-600 hover:bg-yellow-500'} text-white shadow-md`}
        >
          <FastForward size={20} className="mr-2" />
          {adTimeRemaining > 0 ? `Ad: ${adTimeRemaining}s` : 'Skip (Watch Ad)'}
        </button>
        <button
          onClick={handleMarkDone}
          className="flex-1 flex items-center justify-center py-3 rounded-xl bg-green-600 hover:bg-green-500 text-white font-semibold transition-colors shadow-md"
        >
          <Check size={20} className="mr-2" />
          Mark as Done
        </button>
      </div>

      {/* Global Pause Overlay */}
      {(workoutState === 'paused' || workoutState === 'ad-break') && (
        <div className="absolute inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center backdrop-blur-sm">
          <button
            onClick={workoutState === 'paused' ? handlePauseToggle : null}
            className={`p-6 bg-indigo-600 text-white rounded-full shadow-2xl transform transition-transform ${workoutState === 'paused' ? 'hover:scale-110' : 'opacity-80'}`}
          >
